name: ImmortalWrt XGP Build & Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ğŸ‘ˆ å¿…é¡»ï¼Œä¸ºäº† git log

      - name: Determine channel
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "CHANNEL=nightly" >> $GITHUB_ENV
          else
            echo "CHANNEL=stable" >> $GITHUB_ENV
          fi

      - name: Build
        run: |
          chmod +x build-immortalwrt-gha.sh
          ./build-immortalwrt-gha.sh

      - name: Prepare firmware & metadata
        run: |
          set -e
          cd immortalwrt

          KERNEL=$(grep -R "LINUX_VERSION-" include | head -n1 | sed 's/.*=//')
          GITHASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)

          OUT=bin/targets/rockchip/armv8
          PREFIX="ImmortalWrt-XGP-v3-${KERNEL}-g${GITHASH}-${DATE}"

          cd $OUT

          for f in *sysupgrade*.img.gz; do
            mv "$f" "${PREFIX}-sysupgrade.img.gz"
          done

          sha256sum *.img.gz > sha256sums

          ls -lah

      - name: Generate driver changelog
        run: |
          set -e
          LAST_TAG=$(git tag --sort=-creatordate | head -n1)

          if [ -z "$LAST_TAG" ]; then
            echo "### é©±åŠ¨ / QModem å˜æ›´" > driver.log
            echo "é¦–æ¬¡æ„å»ºï¼Œæ— å†å²è®°å½•ã€‚" >> driver.log
          else
            echo "### é©±åŠ¨ / QModem å˜æ›´" > driver.log
            git log ${LAST_TAG}..HEAD \
              -- package/qmodem package/network target/linux/rockchip \
              --oneline >> driver.log || echo "æ— å˜æ›´è®°å½•" >> driver.log
          fi

          cat driver.log

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.CHANNEL }}-${{ github.run_number }}
          name: ImmortalWrt XGP ${{ env.CHANNEL }} æ„å»º
          body: |
            âœ… ç¼–è¯‘é€šé“ï¼š${{ env.CHANNEL }}
            âœ… Kernelï¼šå·²é›†æˆ
            âœ… Gitï¼š${{ github.sha }}

            $(cat driver.log)
          files: |
            immortalwrt/bin/targets/rockchip/armv8/*.img.gz
            immortalwrt/bin/targets/rockchip/armv8/sha256sums
            immortalwrt/bin/targets/rockchip/armv8/manifest
            immortalwrt/bin/targets/rockchip/armv8/config.buildinfo
