name: ImmortalWrt XGP Build & Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 4'

permissions:
  contents: write   # ğŸ‘ˆ åˆ›å»º Release å¿…é¡»

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Show system info
        run: |
          df -h
          free -h
          nproc

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          swap-size-mb: 1024
          remove-dotnet: 'false'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Debug workspace
        run: |
          pwd
          ls -lah
          test -f build-immortalwrt-gha.sh

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl \
            device-tree-compiler ecj fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gnutls-dev gperf \
            haveged help2man intltool \
            lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses-dev \
            libpython3-dev libreadline-dev libssl-dev \
            libtool libyaml-dev libz-dev \
            lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf \
            python3 python3-pip python3-ply python3-pyelftools \
            qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl \
            unzip vim wget xmlto xxd \
            zlib1g-dev zstd

      - name: Cache dl & staging_dir
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/dl
            immortalwrt/staging_dir
          key: ${{ runner.os }}-immortalwrt-${{ hashFiles('xgp.config') }}

      - name: Build ImmortalWrt (capture log)
        shell: bash
        run: |
          set -o pipefail
          chmod +x build-immortalwrt-gha.sh
          ./build-immortalwrt-gha.sh 2>&1 | tee build.log || true

          if grep -n -E "error: .*failed|^make.*Error|^ERROR:" build.log; then
            echo "âŒ Build failed, first error:"
            grep -n -E "error: .*failed|^make.*Error|^ERROR:" build.log | head -n 1
            exit 1
          fi

      - name: Rename firmware
        if: success()
        run: |
          set -e
          cd immortalwrt/bin/targets/rockchip/armv8

          DATE=$(date +%Y%m%d)
          TIME=$(date +%H%M)
          PREFIX="ImmortalWrt-XGP-v3-${DATE}-${TIME}"

          for f in *sysupgrade*.img.gz; do
            mv "$f" "${PREFIX}-sysupgrade.img.gz"
          done

          ls -lah

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: ImmortalWrt XGP è‡ªåŠ¨æ„å»º #${{ github.run_number }}
          body: |
            âœ… ImmortalWrt XGP è‡ªåŠ¨ç¼–è¯‘å®Œæˆ

            - æ„å»ºæ—¶é—´ï¼š${{ github.run_started_at }}
            - åˆ†æ”¯ï¼š${{ github.ref_name }}
            - Commitï¼š${{ github.sha }}

            å›ºä»¶å·²é€šè¿‡ GitHub Actions è‡ªåŠ¨ç¼–è¯‘å¹¶ä¸Šä¼ ã€‚
          files: |
            immortalwrt/bin/targets/rockchip/armv8/*.img.gz
