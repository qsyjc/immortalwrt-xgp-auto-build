name: ImmortalWrt Full Build & Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------- 构建依赖（你确认过的版本） --------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache \
            clang cmake cpio curl device-tree-compiler \
            ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged \
            help2man intltool lib32gcc-s1 libc6-dev-i386 \
            libelf-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev \
            libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool \
            libyaml-dev libz-dev lld llvm lrzsz \
            mkisofs msmtp nano ninja-build \
            p7zip p7zip-full patch pkgconf \
            python3 python3-pip python3-ply \
            python3-pyelftools qemu-utils re2c \
            rsync scons squashfs-tools subversion \
            swig texinfo uglifyjs upx-ucl unzip \
            vim wget xmlto xxd zlib1g-dev zstd

      - name: Ensure build script is executable
        run: |
          chmod +x build-immortalwrt.sh

      - name: Run build script
        id: build
        run: |
          ./build-immortalwrt.sh

      - name: Show summary
        run: |
          echo "----- Build summary -----"
          cat build_summary.txt || true
          echo "-------------------------"

      - name: Upload artifacts (firmware)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-artifacts
          path: |
            immortalwrt/bin/targets/**
            build_summary.txt

      - name: Prepare release metadata
        if: success()
        id: meta
        run: |
          . ./build_summary.txt
          DATE_TAG=$(date -u +"%Y%m%d%H%M")
          SHORT_SHA=$(git rev-parse --short HEAD || echo "nogit")
          TAG="build-${DATE_TAG}-${SHORT_SHA}-${BUILD_UUID}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "name=ImmortalWrt build ${BUILD_REVISION} ${DATE_TAG}" >> $GITHUB_OUTPUT
          # compute artifact path (pick first bin/targets subdir)
          ART_DIR=$(ls -d immortalwrt/bin/targets/* 2>/dev/null | head -n1 || true)
          echo "artifact_dir=${ART_DIR}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          body: |
            Auto build from ${{ github.repository }}@${{ github.sha }}
            Build UUID: ${{ steps.meta.outputs.tag }}
            Build info:
            $(cat build_summary.txt || true)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        if: success()
        run: |
          ART_DIR="${{ steps.meta.outputs.artifact_dir }}"
          if [ -d "$ART_DIR" ]; then
            echo "Uploading assets from $ART_DIR"
            for f in $(find "$ART_DIR" -type f -name "*.bin" -o -name "*.img" -o -name "*.tar" -o -name "*.gz" -o -name "*.ipk" -o -name "*.zip" 2>/dev/null); do
              echo "Uploading $f"
              gh release upload "${{ steps.meta.outputs.tag }}" "$f" --clobber || true
            done
          else
            echo "No artifact dir: $ART_DIR"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # gh cli is required; install if not present:
      - name: Ensure GitHub CLI installed
        if: success()
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt update
            sudo apt install -y gh
          fi
